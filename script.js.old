import { 
    showPage, 
    showSupervisorPage, 
    showManagePublished,
    initializePageContent
} from './js/components/navigation.js';
import { 
    checkPassword, 
    closePasswordModal,
    openEditModal,
    closeEditModal 
} from './js/components/modals.js';
import {
    previewVersion,
    deleteVersion,
    confirmDeleteVersion,
    clearAllVersions
} from './js/components/versionManager.js';
import { publishSchedule } from './js/storage/localStorageManager.js';
import { refreshScheduleFromSheets, restartFromGoogleSheets } from './js/api/googleSheets.js';

// Make functions available globally
window.showPage = showPage;
window.showSupervisorPage = showSupervisorPage;
window.showManagePublished = showManagePublished;
window.checkPassword = checkPassword;
window.closePasswordModal = closePasswordModal;
window.openEditModal = openEditModal;
window.closeEditModal = closeEditModal;
window.previewVersion = previewVersion;
window.deleteVersion = deleteVersion;
window.confirmDeleteVersion = confirmDeleteVersion;
window.clearAllVersions = clearAllVersions;
window.publishSchedule = publishSchedule;
window.refreshScheduleFromSheets = refreshScheduleFromSheets;
window.restartFromGoogleSheets = restartFromGoogleSheets;

// Make functions globally available
window.showPage = showPage;
window.showSupervisorPage = showSupervisorPage;
window.showManagePublished = showManagePublished;
window.checkPassword = checkPassword;
window.closePasswordModal = closePasswordModal;
window.previewVersion = previewVersion;
window.deleteVersion = deleteVersion;
window.openEditModal = openEditModal;
window.closeEditModal = closeEditModal;

// Fetch schedule data from Google Sheets
async function fetchScheduleFromGoogleSheets() {
    try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
        console.log('Fetching from Google Sheets...', url);
        
        const response = await fetch(url);
        
        console.log('Response status:', response.status);
        console.log('Response OK:', response.ok);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Successfully fetched data, rows:', data.values ? data.values.length : 0);
        return parseScheduleData(data.values || []);
    } catch (error) {
        console.error('Detailed error fetching schedule data:', error);
        console.error('Error type:', error.name);
        console.error('Error message:', error.message);
        alert('Error loading schedule from Google Sheets: ' + error.message + '\n\nUsing local data instead. Check console for details.');
        return [];
    }
}

// Parse the Google Sheets data into calendar events
function parseScheduleData(rows) {
    const events = [];
    
    rows.forEach((row, index) => {
        const dateValue = row[0];
        if (!dateValue) return;

        // Parse date
        let date;
        if (dateValue instanceof Date) {
            date = dateValue;
        } else if (typeof dateValue === 'string') {
            date = new Date(dateValue);
            if (isNaN(date.getTime())) {
                const parts = dateValue.split('/');
                if (parts.length === 3) {
                    date = new Date(parts[2], parts[0] - 1, parts[1]);
                }
            }
        } else {
            return;
        }

        if (isNaN(date.getTime())) return;

        const dayShift = row[16] || '';
        const nightShift = row[17] || '';
        const school = row[18] || '';
        const off = row[19] || ''; // Column T - people who are off
        const displayDayShift = dayShift.replace(/blank/gi, '_');
        const displayNightShift = nightShift.replace(/blank/gi, '_');
        const isWeekend = date.getDay() === 0 || date.getDay() === 6;

        // Clean shifts for calculations
        const cleanNightShift = nightShift
            .replace(/blank/gi, '')
            .replace(/[\s\u00A0]/g, '')
            .replace(/\/+/g, '/')
            .replace(/^\/|\/$/g, '');
        
        const cleanDayShift = dayShift
            .replace(/blank/gi, '')
            .replace(/[\s\u00A0]/g, '')
            .replace(/\/+/g, '/')
            .replace(/^\/|\/$/g, '');

        // Format date for FullCalendar
        const formattedDate = date.toISOString().split('T')[0];

        // Create event title
        let title = '';
        if (isWeekend) {
            if (displayDayShift.trim()) {
                title = displayDayShift.trim();
            }
        } else {
            if (displayDayShift.trim()) {
                title += `Day: ${displayDayShift.trim()}`;
            }
            if (displayNightShift.trim()) {
                if (title) title += '\nNight: ';
                else title += 'Night: ';
                title += displayNightShift.trim();
            }
            if (school.trim()) {
                if (title) title += '\n';
                title += `School: ${school.trim()}`;
            }
            if (off.trim()) {
                if (title) title += '\n';
                title += `Off: ${off.trim()}`;
            }
        }

        // Only add event if there's actual schedule data
        if (title.trim()) {
            const dayStaffCount = cleanDayShift ? cleanDayShift.split('/').filter(s => s.trim()).length : 0;
            const nightStaffCount = cleanNightShift ? cleanNightShift.split('/').filter(s => s.trim()).length : 0;
            const totalStaff = dayStaffCount + nightStaffCount;
            
            let backgroundColor;
            
            if (isWeekend) {
                if (totalStaff === 2) {
                    backgroundColor = '#f8f9fa';
                } else if (totalStaff === 1) {
                    backgroundColor = '#26de81';
                } else if (totalStaff === 0) {
                    backgroundColor = '#ff6b6b';
                } else {
                    backgroundColor = '#f8f9fa';
                }
            } else {
                const nightShiftBlankCount = (nightShift.match(/blank/gi) || []).length;
                
                if ((nightShiftBlankCount === 2 || cleanNightShift === '') && cleanDayShift !== '') {
                    backgroundColor = '#ff6b6b';
                } else if (nightShiftBlankCount === 1 && cleanDayShift !== '') {
                    backgroundColor = '#26de81';
                } else if (totalStaff === 6) {
                    backgroundColor = '#f8f9fa';
                } else if (totalStaff === 5) {
                    backgroundColor = '#26de81';
                } else if (totalStaff <= 4 && totalStaff > 0) {
                    backgroundColor = '#ff6b6b';
                } else {
                    backgroundColor = '#6c757d';
                }
            }

            events.push({
                title: title,
                start: formattedDate,
                backgroundColor: backgroundColor,
                borderColor: backgroundColor,
                textColor: getTextColor(backgroundColor),
                allDay: true,
                extendedProps: {
                    dayShift: displayDayShift.trim(),
                    nightShift: displayNightShift.trim(),
                    cleanDayShift: cleanDayShift,
                    cleanNightShift: cleanNightShift,
                    source: 'googleSheets'
                }
            });
        }
    });
    
    return events;
}

// Get appropriate text color based on background
function getTextColor(backgroundColor) {
    const darkColors = ['#6c757d', '#dc3545', '#6c5ce7', '#a55eea'];
    return darkColors.includes(backgroundColor) ? 'white' : 'black';
}

// Modified function to load events - prioritizes published versions over Google Sheets
async function loadPublishedEvents() {
    const publishedData = localStorage.getItem('perfusionPublishedSchedule');
    if (publishedData) {
        const data = JSON.parse(publishedData);
        return data.events || [];
    }
    
    const googleSheetsEvents = await fetchScheduleFromGoogleSheets();
    return googleSheetsEvents;
}

// Modified function to load events for EDITING
async function loadEventsForEditing() {
    const publishedData = localStorage.getItem('perfusionPublishedSchedule');
    if (publishedData) {
        const data = JSON.parse(publishedData);
        return data.events || [];
    }
    
    const googleSheetsEvents = await fetchScheduleFromGoogleSheets();
    return googleSheetsEvents;
}

// Page navigation function
function showPage(pageId) {
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => page.classList.remove('active'));
    
    document.getElementById(pageId).classList.add('active');
    
    if (pageId === 'supervisorPage') {
        // Supervisor page
    } else if (pageId === 'supervisorViewPage' && !supervisorViewCalendar) {
        initializeSupervisorViewCalendar();
    } else if (pageId === 'supervisorEditPage' && !supervisorEditCalendar) {
        initializeSupervisorEditCalendar();
    } else if (pageId === 'publishedSchedulePage') {
        initializePublishedCalendar();
    } else if (pageId === 'previousSchedulePage' && !previousCalendar) {
        initializePreviousCalendar();
    } else if (pageId === 'managePublishedPage') {
        initializeManagePublished();
    }
}

// Function to show supervisor page with password protection
function showSupervisorPage() {
    document.getElementById('passwordModal').style.display = 'block';
    document.getElementById('passwordInput').focus();
}

// Function to show the manage published page
function showManagePublished() {
    showPage('managePublishedPage');
}

// Initialize the manage published page
function initializeManagePublished() {
    displayPublishedVersions();
}

// Display all published versions
function displayPublishedVersions() {
    const versionsList = document.getElementById('publishedVersionsList');
    const clearAllBtn = document.getElementById('clearAllBtn');
    
    const currentPublished = localStorage.getItem('perfusionPublishedSchedule');
    const historyData = localStorage.getItem('perfusionScheduleHistory');
    const history = historyData ? JSON.parse(historyData) : [];
    
    versionsList.innerHTML = '';
    
    if (currentPublished) {
        const currentData = JSON.parse(currentPublished);
        const currentVersionNum = history.length + 1;
        const versionItem = createVersionItem(currentVersionNum, currentData, true);
        versionsList.appendChild(versionItem);
    }
    
    for (let i = history.length - 1; i >= 0; i--) {
        const version = history[i];
        const versionNum = i + 1;
        const versionItem = createVersionItem(versionNum, version, false);
        versionsList.appendChild(versionItem);
    }
    
    if (history.length === 0 && !currentPublished) {
        versionsList.innerHTML = '<div class="no-versions-message">No published versions found.<br><br><em>Note: The schedule is now loaded directly from Google Sheets. Manual publishing is only needed for saving specific versions.</em></div>';
        clearAllBtn.style.display = 'none';
    } else if (history.length > 0) {
        clearAllBtn.style.display = 'block';
    } else {
        clearAllBtn.style.display = 'none';
    }
}

// Create a version item element
function createVersionItem(versionNum, versionData, isCurrent) {
    const item = document.createElement('div');
    item.className = `version-item ${isCurrent ? 'current-version' : ''}`;
    
    const date = new Date(versionData.timestamp);
    const formattedDate = date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric'
    });
    const formattedTime = date.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
    });
    
    item.innerHTML = `
        <div class="version-info-left">
            <div class="version-title">
                Version ${versionNum}
                <span class="version-status ${isCurrent ? 'status-current' : 'status-archived'}">
                    ${isCurrent ? 'Current' : 'Archived'}
                </span>
            </div>
            <div class="version-details">
                Published on ${formattedDate} at ${formattedTime}
            </div>
        </div>
        <div class="version-actions">
            <button class="preview-button" onclick="previewVersion(${versionNum}, ${isCurrent})">
                Preview
            </button>
            ${!isCurrent ? `<button class="delete-button" onclick="confirmDeleteVersion(${versionNum})">Delete</button>` : 
              '<button class="delete-button" disabled title="Cannot delete current version">Delete</button>'}
        </div>
    `;
    
    return item;
}

// Preview a specific version
function previewVersion(versionNum, isCurrent) {
    if (isCurrent) {
        showPage('publishedSchedulePage');
    } else {
        const historyData = localStorage.getItem('perfusionScheduleHistory');
        const history = historyData ? JSON.parse(historyData) : [];
        
        if (history.length > 0) {
            const versionIndex = history.length - versionNum;
            const versionData = history[versionIndex];
            
            if (versionData) {
                showPage('publishedSchedulePage');
                setTimeout(() => {
                    selectVersionTab(versionNum, versionData, false);
                }, 500);
            }
        }
    }
}

// Confirm deletion of a version
function confirmDeleteVersion(versionNum) {
    if (confirm(`Are you sure you want to delete Version ${versionNum}? This action cannot be undone.`)) {
        deleteVersion(versionNum);
    }
}

// Delete a specific version
function deleteVersion(versionNum) {
    try {
        const historyData = localStorage.getItem('perfusionScheduleHistory');
        let history = historyData ? JSON.parse(historyData) : [];
        
        if (history.length > 0) {
            const versionIndex = history.length - versionNum;
            
            if (versionIndex >= 0 && versionIndex < history.length) {
                history.splice(versionIndex, 1);
                localStorage.setItem('perfusionScheduleHistory', JSON.stringify(history));
                displayPublishedVersions();
                alert(`Version ${versionNum} has been deleted successfully.`);
            } else {
                alert('Error: Version not found.');
            }
        }
    } catch (error) {
        console.error('Error deleting version:', error);
        alert('Error deleting version. Please try again.');
    }
}

// Clear all old versions
function clearAllVersions() {
    const historyData = localStorage.getItem('perfusionScheduleHistory');
    const history = historyData ? JSON.parse(historyData) : [];
    
    if (history.length === 0) {
        alert('No old versions to clear.');
        return;
    }
    
    const confirmMsg = `Are you sure you want to delete all ${history.length} old versions? This will keep only the current version and cannot be undone.`;
    
    if (confirm(confirmMsg)) {
        try {
            localStorage.removeItem('perfusionScheduleHistory');
            displayPublishedVersions();
            alert('All old versions have been cleared successfully.');
        } catch (error) {
            console.error('Error clearing versions:', error);
            alert('Error clearing versions. Please try again.');
        }
    }
}

// Password modal functions
function requestEditAccess() {
    showPage('supervisorEditPage');
}

function requestManageAccess() {
    showManagePublished();
}

function closePasswordModal() {
    document.getElementById('passwordModal').style.display = 'none';
    document.getElementById('passwordInput').value = '';
    document.getElementById('passwordError').style.display = 'none';
}

function checkPassword() {
    const enteredPassword = document.getElementById('passwordInput').value;
    const errorDiv = document.getElementById('passwordError');
    
    if (enteredPassword === SUPERVISOR_PASSWORD) {
        closePasswordModal();
        showPage('supervisorPage');
    } else {
        errorDiv.textContent = 'Incorrect password. Please try again.';
        errorDiv.style.display = 'block';
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordInput').focus();
    }
}

// Allow Enter key to submit password
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('passwordInput');
    if (passwordInput) {
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
    }
});

// Edit modal functions
function openEditModal(date, dayShift = '', nightShift = '', backgroundColor = 'auto') {
    currentEditingDate = date;
    document.getElementById('editModalTitle').textContent = `Edit Schedule for ${date}`;
    document.getElementById('dayShiftInput').value = dayShift;
    document.getElementById('nightShiftInput').value = nightShift;
    
    const colorRadios = document.querySelectorAll('input[name="backgroundColor"]');
    colorRadios.forEach(radio => {
        radio.checked = radio.value === backgroundColor;
    });
    
    document.getElementById('editModal').style.display = 'block';
    document.getElementById('dayShiftInput').focus();
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    currentEditingDate = null;
}

function saveEdit() {
    const dayShiftInput = document.getElementById('dayShiftInput');
    const nightShiftInput = document.getElementById('nightShiftInput');
    const backgroundColorRadio = document.querySelector('input[name="backgroundColor"]:checked');
    
    if (!dayShiftInput || !nightShiftInput || !backgroundColorRadio) {
        console.error('Required form elements not found');
        alert('Error: Form elements not found. Please try again.');
        return;
    }
    
    const dayShift = dayShiftInput.value;
    const nightShift = nightShiftInput.value;
    const backgroundColor = backgroundColorRadio.value;
    
    if (currentEditingDate && supervisorEditCalendar) {
        const displayDayShift = dayShift.replace(/blank/gi, '_');
        const displayNightShift = nightShift.replace(/blank/gi, '_');

        let title = '';
        if (displayDayShift.trim()) {
            title += `Day: ${displayDayShift.trim()}`;
        }
        if (displayNightShift.trim()) {
            if (title) title += '\nNight: ';
            else title += 'Night: ';
            title += displayNightShift.trim();
        }
        
        let eventColor = backgroundColor;
        if (backgroundColor === 'auto') {
            const cleanDayShift = dayShift.replace(/blank/gi, '').replace(/[\s\u00A0]/g, '').replace(/\/+/g, '/').replace(/^\/|\/$/g, '');
            const cleanNightShift = nightShift.replace(/blank/gi, '').replace(/[\s\u00A0]/g, '').replace(/\/+/g, '/').replace(/^\/|\/$/g, '');
            
            const dayCount = cleanDayShift ? cleanDayShift.split('/').filter(s => s.trim()).length : 0;
            const nightCount = cleanNightShift ? cleanNightShift.split('/').filter(s => s.trim()).length : 0;
            const totalStaff = dayCount + nightCount;
            
            const eventDate = new Date(currentEditingDate);
            const isWeekend = eventDate.getDay() === 0 || eventDate.getDay() === 6;
            
            if (isWeekend) {
                if (totalStaff === 2) {
                    eventColor = '#f8f9fa';
                } else if (totalStaff === 1) {
                    eventColor = '#26de81';
                } else if (totalStaff === 0) {
                    eventColor = '#ff6b6b';
                } else {
                    eventColor = '#f8f9fa';
                }
            } else {
                if (cleanNightShift === '' && cleanDayShift !== '') {
                    eventColor = '#26de81';
                } else if (totalStaff === 6) {
                    eventColor = '#f8f9fa';
                } else if (totalStaff === 5) {
                    eventColor = '#26de81';
                } else if (totalStaff <= 4 && totalStaff > 0) {
                    eventColor = '#ff6b6b';
                } else {
                    eventColor = '#6c757d';
                }
            }
        }
        
        const existingEvents = supervisorEditCalendar.getEvents();
        existingEvents.forEach(event => {
            if (event.startStr === currentEditingDate) {
                event.remove();
            }
        });
        
        if (title.trim()) {
            supervisorEditCalendar.addEvent({
                title: title,
                start: currentEditingDate,
                backgroundColor: eventColor,
                borderColor: eventColor,
                textColor: getTextColor(eventColor),
                allDay: true,
                extendedProps: {
                    dayShift: dayShift,
                    nightShift: nightShift,
                    source: 'manual'
                }
            });
        }
        
        closeEditModal();
    }
}

// Calendar initialization functions
async function initializeSupervisorViewCalendar() {
    const events = await loadPublishedEvents();
    
    supervisorViewCalendar = new FullCalendar.Calendar(document.getElementById('supervisorViewCalendar'), {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: events,
        height: 'auto',
        eventDisplay: 'block',
        eventContent: function(arg) {
            const lines = arg.event.title.split('\n');
            let html = '<div class="fc-event-main-frame"><div class="fc-event-title-container"><div class="fc-event-title fc-sticky">';
            lines.forEach(line => {
                if (line.startsWith('School:')) {
                    html += `<div style="background-color: #ffeb3b; color: #000; padding: 2px 4px; margin-top: 2px;">${line}</div>`;
                } else if (line.startsWith('Off:')) {
                    html += `<div style="background-color: #9e9e9e; color: #fff; padding: 2px 4px; margin-top: 2px;">${line}</div>`;
                } else {
                    html += `<div>${line}</div>`;
                }
            });
            html += '</div></div></div>';
            return { html: html };
        },
        eventClick: function(info) {
            const event = info.event;
            const dayShift = event.extendedProps.dayShift || '';
            const nightShift = event.extendedProps.nightShift || '';
            const eventDate = event.start.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let message = `Schedule for ${eventDate}\n\n`;
            if (dayShift) {
                message += `Day Shift:\n${dayShift}\n\n`;
            }
            if (nightShift) {
                message += `Night Shift:\n${nightShift}`;
            }
            
            if (!dayShift && !nightShift) {
                message += 'No staff assigned for this date.';
            }
            
            alert(message);
        }
    });
    
    supervisorViewCalendar.render();
}

async function initializeSupervisorEditCalendar() {
    const events = await loadEventsForEditing();
    
    supervisorEditCalendar = new FullCalendar.Calendar(document.getElementById('supervisorEditCalendar'), {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: events,
        height: 'auto',
        eventDisplay: 'block',
        eventContent: function(arg) {
            const lines = arg.event.title.split('\n');
            let html = '<div class="fc-event-main-frame"><div class="fc-event-title-container"><div class="fc-event-title fc-sticky">';
            lines.forEach(line => {
                if (line.startsWith('School:')) {
                    html += `<div style="background-color: #ffeb3b; color: #000; padding: 2px 4px; margin-top: 2px;">${line}</div>`;
                } else {
                    html += `<div>${line}</div>`;
                }
            });
            html += '</div></div></div>';
            return { html: html };
        },
        dateClick: function(info) {
            const existingEvent = supervisorEditCalendar.getEvents().find(event => 
                event.startStr === info.dateStr
            );
            
            if (existingEvent) {
                const dayShift = existingEvent.extendedProps.dayShift || '';
                const nightShift = existingEvent.extendedProps.nightShift || '';
                
                openEditModal(info.dateStr, dayShift, nightShift, existingEvent.backgroundColor);
            } else {
                openEditModal(info.dateStr);
            }
        },
        eventClick: function(info) {
            const event = info.event;
            const dayShift = event.extendedProps.dayShift || '';
            const nightShift = event.extendedProps.nightShift || '';
            
            openEditModal(info.event.startStr, dayShift, nightShift, event.backgroundColor);
        }
    });
    
    supervisorEditCalendar.render();
}

async function initializePublishedCalendar() {
    if (calendar) {
        calendar.destroy();
    }
    
    const events = await loadPublishedEvents();
    
    calendar = new FullCalendar.Calendar(document.getElementById('publishedCalendar'), {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: events,
        height: 'auto',
        eventDisplay: 'block',
        eventContent: function(arg) {
            const lines = arg.event.title.split('\n');
            let html = '<div class="fc-event-main-frame"><div class="fc-event-title-container"><div class="fc-event-title fc-sticky">';
            lines.forEach(line => {
                if (line.startsWith('School:')) {
                    html += `<div style="background-color: #ffeb3b; color: #000; padding: 2px 4px; margin-top: 2px;">${line}</div>`;
                } else {
                    html += `<div>${line}</div>`;
                }
            });
            html += '</div></div></div>';
            return { html: html };
        },
        eventClick: function(info) {
            const event = info.event;
            const dayShift = event.extendedProps.dayShift || '';
            const nightShift = event.extendedProps.nightShift || '';
            const eventDate = event.start.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let message = `Schedule for ${eventDate}\n\n`;
            if (dayShift) {
                message += `Day Shift:\n${dayShift}\n\n`;
            }
            if (nightShift) {
                message += `Night Shift:\n${nightShift}`;
            }
            
            if (!dayShift && !nightShift) {
                message += 'No staff assigned for this date.';
            }
            
            alert(message);
        }
    });
    
    calendar.render();
    updateScheduleInfo(events);
}

function initializePreviousCalendar() {
    previousCalendar = new FullCalendar.Calendar(document.getElementById('previousCalendar'), {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: [],
        height: 'auto',
        eventDisplay: 'block'
    });
    previousCalendar.render();
}

// Publish schedule function
function publishSchedule() {
    if (!supervisorEditCalendar) {
        alert('No calendar data to publish.');
        return;
    }
    
    const events = supervisorEditCalendar.getEvents().map(event => ({
        title: event.title,
        start: event.startStr,
        backgroundColor: event.backgroundColor,
        borderColor: event.borderColor,
        textColor: event.textColor,
        allDay: event.allDay,
        extendedProps: event.extendedProps
    }));
    
    const publishData = {
        events: events,
        timestamp: new Date().toISOString(),
        version: currentPublishedVersion
    };
    
    const currentPublished = localStorage.getItem('perfusionPublishedSchedule');
    if (currentPublished) {
        const historyData = localStorage.getItem('perfusionScheduleHistory');
        const history = historyData ? JSON.parse(historyData) : [];
        history.push(JSON.parse(currentPublished));
        localStorage.setItem('perfusionScheduleHistory', JSON.stringify(history));
    }
    
    localStorage.setItem('perfusionPublishedSchedule', JSON.stringify(publishData));
    currentPublishedVersion++;
    
    alert('Schedule published successfully!');
    showPage('publishedSchedulePage');
}

// Version tabs functions
function initializeVersionTabs() {
    const tabsContainer = document.getElementById('versionTabs');
    const tabsContainerDiv = document.getElementById('versionTabsContainer');
    
    const currentPublished = localStorage.getItem('perfusionPublishedSchedule');
    const historyData = localStorage.getItem('perfusionScheduleHistory');
    const history = historyData ? JSON.parse(historyData) : [];
    
    tabsContainer.innerHTML = '';
    
    if (currentPublished || history.length > 0) {
        tabsContainerDiv.style.display = 'block';
        
        if (currentPublished) {
            const currentData = JSON.parse(currentPublished);
            const currentVersionNum = history.length + 1;
            const tab = createVersionTab(currentVersionNum, currentData, true);
            tabsContainer.appendChild(tab);
        }
        
        history.forEach((version, index) => {
            const versionNum = history.length - index;
            const tab = createVersionTab(versionNum, version, false);
            tabsContainer.appendChild(tab);
        });
    } else {
        tabsContainerDiv.style.display = 'none';
    }
}

function createVersionTab(versionNum, versionData, isCurrent) {
    const tab = document.createElement('button');
    tab.className = `version-tab ${isCurrent ? 'active' : ''}`;
    tab.textContent = `Version ${versionNum}${isCurrent ? ' (Current)' : ''}`;
    tab.onclick = () => selectVersionTab(versionNum, versionData, isCurrent);
    return tab;
}

function selectVersionTab(versionNum, versionData, isCurrent) {
    document.querySelectorAll('.version-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    const tabs = document.querySelectorAll('.version-tab');
    tabs.forEach(tab => {
        if (tab.textContent.includes(`Version ${versionNum}`)) {
            tab.classList.add('active');
        }
    });
    
    if (calendar) {
        calendar.removeAllEvents();
        if (versionData.events) {
            versionData.events.forEach(eventData => {
                calendar.addEvent(eventData);
            });
        }
    }
    
    const lastUpdatedDiv = document.getElementById('lastUpdated');
    const date = new Date(versionData.timestamp);
    const status = isCurrent ? 'Current Published Schedule' : `Version ${versionNum} (Archived)`;
    lastUpdatedDiv.textContent = `${status} - Published: ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}`;
}

// Update schedule information display
function updateScheduleInfo(events) {
    const lastUpdatedDiv = document.getElementById('lastUpdated');
    
    const publishedData = localStorage.getItem('perfusionPublishedSchedule');
    
    if (publishedData) {
        const data = JSON.parse(publishedData);
        const date = new Date(data.timestamp);
        lastUpdatedDiv.textContent = `Current Published Schedule - Last published: ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}`;
    } else if (events.length > 0) {
        const now = new Date();
        lastUpdatedDiv.textContent = `Schedule loaded from Google Sheets at ${now.toLocaleString()}`;
    } else {
        lastUpdatedDiv.textContent = 'No schedule data available';
    }
    
    initializeVersionTabs();
}

// Add refresh button functionality
async function refreshScheduleFromSheets() {
    if (calendar) {
        await initializePublishedCalendar();
    }
    if (supervisorViewCalendar) {
        supervisorViewCalendar.destroy();
        supervisorViewCalendar = null;
        await initializeSupervisorViewCalendar();
    }
    alert('Schedule refreshed from Google Sheets!');
}

// Restart schedule from Google Sheets (clears local data)
async function restartFromGoogleSheets() {
    const confirmMsg = `This will clear all published versions and restart with fresh data from Google Sheets. This action cannot be undone. Are you sure?`;
    
    if (confirm(confirmMsg)) {
        try {
            localStorage.removeItem('perfusionPublishedSchedule');
            localStorage.removeItem('perfusionScheduleHistory');
            
            currentPublishedVersion = 1;
            
            if (supervisorEditCalendar) {
                supervisorEditCalendar.destroy();
                supervisorEditCalendar = null;
            }
            
            const googleSheetsEvents = await fetchScheduleFromGoogleSheets();
            
            supervisorEditCalendar = new FullCalendar.Calendar(document.getElementById('supervisorEditCalendar'), {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: googleSheetsEvents,
                height: 'auto',
                eventDisplay: 'block',
                dateClick: function(info) {
                    const existingEvent = supervisorEditCalendar.getEvents().find(event => 
                        event.startStr === info.dateStr
                    );
                    
                    if (existingEvent) {
                        const dayShift = existingEvent.extendedProps.dayShift || '';
                        const nightShift = existingEvent.extendedProps.nightShift || '';
                        
                        openEditModal(info.dateStr, dayShift, nightShift, existingEvent.backgroundColor);
                    } else {
                        openEditModal(info.dateStr);
                    }
                },
                eventClick: function(info) {
                    const event = info.event;
                    const dayShift = event.extendedProps.dayShift || '';
                    const nightShift = event.extendedProps.nightShift || '';
                    
                    openEditModal(info.event.startStr, dayShift, nightShift, event.backgroundColor);
                }
            });
            
            supervisorEditCalendar.render();
            
            alert('Schedule restarted with fresh data from Google Sheets! All local versions have been cleared.');
        } catch (error) {
            console.error('Error restarting from Google Sheets:', error);
            alert('Error loading fresh data from Google Sheets. Please try again.');
        }
    }
}

// Close modals when clicking outside
window.onclick = function(event) {
    const passwordModal = document.getElementById('passwordModal');
    const editModal = document.getElementById('editModal');
    
    if (event.target === passwordModal) {
        closePasswordModal();
    } else if (event.target === editModal) {
        closeEditModal();
    }
}

// Initialize app when page loads
document.addEventListener('DOMContentLoaded', function() {
    showPage('welcomePage');
});
